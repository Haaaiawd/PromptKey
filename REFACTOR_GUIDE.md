# Prompt Manager 项目重构指导

## 1. 项目现状分析

当前项目存在以下主要问题：

### 1.1 目录结构混乱
- 同时存在顶层 workspace 和嵌套的 prompt-manager/workspace
- 两个 workspace 都有名为 service 的 crate
- 模块实现分散在不同目录中，容易误改

### 1.2 构建与配置问题
- Cargo resolver 版本不一致
- 依赖冗余，存在未使用的依赖
- 多处 dead code 和 unused import 警告

### 1.3 运行时问题
- 热键注册失败
- 消息循环和通道模型存在并发问题
- 缺少错误码输出和冲突降级机制

### 1.4 功能缺口
- 注入器未实现实际逻辑
- 上下文未接入注入流程
- 数据层未提供完整查询功能

### 1.5 配置不一致
- 两套 config 结构不一致
- 错误信息不够明确

### 1.6 可观测性与健壮性不足
- 日志缺少关键错误码
- 缺少自检与自愈机制
- 无单元/集成测试

## 2. 重构步骤

### 2.1 统一项目结构

#### 2.1.1 清理重复目录
1. 删除重复的顶层 service 目录
2. 保留嵌套的 prompt-manager 作为主项目目录
3. 确保所有模块实现在统一位置

#### 2.1.2 规范模块结构
```
prompt-manager/
├── Cargo.toml                 # 工作区配置文件
├── service/                   # 后台服务crate
│   ├── Cargo.toml            # 服务依赖配置
│   └── src/
│       ├── main.rs           # 主程序入口
│       ├── config/           # 配置模块
│       │   └── mod.rs
│       ├── db.rs             # 数据库模块
│       ├── hotkey/           # 热键处理模块
│       │   └── mod.rs
│       ├── injector/         # 注入策略模块
│       │   └── mod.rs
│       └── context/          # 上下文处理模块
│           └── mod.rs
├── README.md                 # 项目说明文档
└── TODO.md                   # 任务清单
```

### 2.2 修复构建与配置问题

#### 2.2.1 统一 Cargo resolver
在 `prompt-manager/Cargo.toml` 中添加:
```toml
[workspace]
resolver = "2"
```

#### 2.2.2 清理未使用依赖
移除未使用的依赖，如 tokio（如果未使用）

#### 2.2.3 修复警告
清理 dead code 和 unused import 警告

### 2.3 解决运行时问题

#### 2.3.1 改进热键注册
1. 添加详细的错误处理和日志输出
2. 实现冲突降级机制
3. 添加 GetLastError 错误码解析

#### 2.3.2 重构消息循环
1. 移除"假接收器"的 hack 实现
2. 使用更合理的线程模型
3. 解耦业务主循环与消息循环

### 2.4 实现核心功能

#### 2.4.1 完善注入器实现
1. 实现 UIA 注入策略的完整逻辑
2. 实现剪贴板注入策略
3. 实现 SendInput 注入策略
4. 添加密码框检测和安全边界

#### 2.4.2 接入上下文信息
1. 将前景窗口/进程名信息贯穿到注入流程
2. 实现上下文感知的模板选择

#### 2.4.3 完善数据层
1. 实现完整的 CRUD 操作
2. 实现模板选择逻辑
3. 连接数据层与注入流程

### 2.5 统一配置管理

#### 2.5.1 合并配置结构
1. 统一 config 结构和默认值策略
2. 确保生成与解析的一致性
3. 添加详细的错误信息

### 2.6 提升可观测性与健壮性

#### 2.6.1 完善日志系统
1. 添加关键 Windows 错误码输出
2. 添加上下文信息到日志
3. 实现自检与自愈机制

#### 2.6.2 添加测试
1. 实现单元测试
2. 实现集成测试
3. 添加端到端冒烟用例

## 3. 具体实施计划

### 3.1 第一阶段：项目结构统一（1-2天）
- [ ] 清理重复目录
- [ ] 规范模块结构
- [ ] 统一 Cargo 配置

### 3.2 第二阶段：构建问题修复（1天）
- [ ] 统一 Cargo resolver
- [ ] 清理未使用依赖
- [ ] 修复所有警告

### 3.3 第三阶段：运行时问题解决（2-3天）
- [ ] 改进热键注册和错误处理
- [ ] 重构消息循环
- [ ] 实现冲突降级机制

### 3.4 第四阶段：核心功能实现（5-7天）
- [ ] 完善注入器实现
- [ ] 接入上下文信息
- [ ] 完善数据层功能

### 3.5 第五阶段：配置与可观测性（2-3天）
- [ ] 统一配置管理
- [ ] 完善日志系统
- [ ] 添加自检与自愈机制

### 3.6 第六阶段：测试完善（2-3天）
- [ ] 实现单元测试
- [ ] 实现集成测试
- [ ] 添加端到端测试

## 4. 质量门禁目标

### 4.1 构建
- [ ] 无警告构建
- [ ] 统一的项目结构
- [ ] 正确的依赖管理

### 4.2 代码质量
- [ ] 无 dead code
- [ ] 无 unused imports
- [ ] 一致的代码风格

### 4.3 测试
- [ ] 单元测试覆盖率 >= 80%
- [ ] 集成测试覆盖核心功能
- [ ] 端到端冒烟测试通过

### 4.4 功能可用性
- [ ] 热键注册成功
- [ ] 注入功能正常工作
- [ ] 端到端流程可运行

## 5. 风险与缓解措施

### 5.1 技术风险
- **Windows API 调用复杂性**：通过详细文档和示例代码降低风险
- **并发编程问题**：使用成熟的并发模式和充分测试

### 5.2 进度风险
- **功能实现复杂度高**：采用分阶段实施，每阶段都有明确目标和验收标准

### 5.3 质量风险
- **代码质量不一致**：建立代码审查机制和编码规范

## 6. 验收标准

### 6.1 构建验收
- 项目可无警告构建
- 依赖管理清晰
- 项目结构统一

### 6.2 功能验收
- 热键可成功注册和触发
- 三种注入策略可正常工作
- 上下文信息正确获取和使用
- 数据库操作正常

### 6.3 质量验收
- 通过所有单元测试
- 通过所有集成测试
- 通过端到端冒烟测试
- 代码无警告和死代码
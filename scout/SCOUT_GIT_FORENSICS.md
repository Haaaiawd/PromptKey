# Git Forensics Report - PromptKey

*Generated by: SCOUT (Phase: Step 3 - Logical Coupling Analysis)*  
*Date: 2025-12-26*  
*Analysis Period: 180 days | Commits: 28*

---

## ğŸ“Š Executive Summary

**Shallow Clone**: âŒ No (å®Œæ•´å†å²)  
**Total Commits**: 28 (ç›¸å¯¹æ–°é¡¹ç›®)  
**Files Analyzed**: 38  
**High Coupling Pairs**: 1  
**Critical Hotspots**: ğŸ”´ **1** (`service/src/injector/mod.rs`)

---

## ğŸ”¥ HOTSPOT ANALYSIS (Code Health Matrix)

### **ğŸ”´ CRITICAL: Refactor NOW**

| File | Churn | Max CCN | NLOC | Debt Score | Status |
|------|-------|---------|------|------------|--------|
| **`service/src/injector/mod.rs`** | 9 | **72** | 715 | **648** | ğŸ”´ **DISASTER ZONE** |

**Analysis**:
- **å¾ªç¯å¤æ‚åº¦ 72**: è¿™æ˜¯æç«¯å¤æ‚çš„ä»£ç ï¼ (æ­£å¸¸é˜ˆå€¼ < 15)
- **æŠ€æœ¯å€ºå¾—åˆ† 648**: æ˜¯ç¬¬äºŒåçš„ 2 å€å¤š
- **ä¿®æ”¹é¢‘ç‡ 9 æ¬¡**: é¢‘ç¹ä¿®æ”¹ + é«˜å¤æ‚åº¦ = Bug å­µåŒ–å™¨
- **Root Cause**: UIA ç­–ç•¥å®ç°åŒ…å«äº†è¿‡å¤šçš„æ¡ä»¶åˆ†æ”¯å’Œç¼–è¾‘å™¨ç‰¹å®šé€»è¾‘

**Recommendation**: 
âœ… **[ä¸ç”¨æˆ·éœ€æ±‚ä¸€è‡´]** - åˆ é™¤ UIA ç­–ç•¥ï¼Œç®€åŒ–åˆ° Clipboard + SendInput

---

### **âš ï¸ MEDIUM: Monitor & Refactor Later**

| File | Churn | Max CCN | NLOC | Debt Score | Priority |
|------|-------|---------|------|------------|----------|
| `src/main.rs` | 13 | 24 | 678 | 312 | Medium |
| `src/main_simple.js` | 8 | 21 | 936 | 168 | Low-Medium |
| `service/src/db.rs` | 5 | 17 | 277 | 85 | Low |
| `service/src/main.rs` | 7 | 12 | 265 | 84 | Low |

**Analysis**:
- `src/main.rs` (GUI): é«˜ä¿®æ”¹é¢‘ç‡ (13æ¬¡)ï¼Œå¤æ‚åº¦é€‚ä¸­ï¼Œéœ€è¦æŒç»­ç›‘æ§
- `src/main_simple.js` (å‰ç«¯é€»è¾‘): 936 è¡Œçš„å•æ–‡ä»¶ JSï¼Œå»ºè®®æ¨¡å—åŒ–

---

### **âœ… STABLE: Low Risk**

ä»¥ä¸‹æ–‡ä»¶ä¿®æ”¹é¢‘ç‡ä½æˆ–å¤æ‚åº¦ä½ï¼Œé£é™©å¯æ§ï¼š
- `service/src/config/mod.rs` (debt: 60)
- `service/src/hotkey/mod.rs` (debt: 57)
- `service/src/context/mod.rs` (debt: 5)

---

## ğŸ”— LOGICAL COUPLING ANALYSIS

### **High Coupling Pairs** (Frequency > 0.7)

#### ğŸ”´ **HIGH_COUPLING: `src/index.html` â†” `src/styles.css`**
- **Frequency**: 0.89 (8/9 commits)
- **Type**: Physical Coupling (åˆç†)
- **Risk**: âœ… Low - è¿™æ˜¯æ­£å¸¸çš„ HTML/CSS é…å¯¹

---

### **Medium Coupling Pairs** (0.3 < Frequency < 0.7)

| File A | File B | Frequency | Count | Notes |
|--------|--------|-----------|-------|-------|
| `service/src/main.rs` | `src/main.rs` | 0.54 | 7 | âš ï¸ è·¨è¿›ç¨‹è€¦åˆ |
| `src/main.rs` | `src/styles.css` | 0.54 | 7 | UI æ”¹åŠ¨ |
| `src/main_simple.js` | `src/styles.css` | 0.67 | 6 | UI é€»è¾‘è€¦åˆ |
| `service/src/db.rs` | `service/src/main.rs` | 0.57 | 4 | åˆç†ä¾èµ– |
| `service/src/config/mod.rs` | `service/src/main.rs` | 0.57 | 4 | åˆç†ä¾èµ– |

---

### **âš ï¸ Hidden Coupling Detected**

#### **`service/src/main.rs` â†” `src/main.rs` (Freq: 0.54)**

**Problem**: 
- åå° Service å’Œ GUI ä¸»è¿›ç¨‹é¢‘ç¹ä¸€èµ·ä¿®æ”¹
- è¯´æ˜ä¸¤ä¸ªè¿›ç¨‹é—´çš„**æ¥å£åè®®**ä¸ç¨³å®š

**Evidence**:
- 7 æ¬¡ commits ä¸­åŒæ—¶ä¿®æ”¹äº†ä¸¤ä¸ªæ–‡ä»¶
- ä½†ä¸¤è€…æ˜¯ç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸åº”è¯¥æœ‰å¦‚æ­¤å¼ºçš„è€¦åˆ

**Root Cause Hypothesis**:
1. **Shared Database Schema**: ä¸¤è¾¹éƒ½ç›´æ¥æ“ä½œ SQLiteï¼Œè¡¨ç»“æ„å˜æ›´æ—¶éœ€è¦åŒæ­¥ä¿®æ”¹
2. **IPC Protocol Changes**: Service å’Œ GUI ä¹‹é—´çš„é€šä¿¡åè®®ä¸ç¨³å®š
3. **Feature Development**: æ–°åŠŸèƒ½å®ç°éœ€è¦åŒæ—¶ä¿®æ”¹å‰åç«¯

**Recommendation**:
- å®šä¹‰ç¨³å®šçš„ **IPC Contract** (JSON Schema æˆ– Protocol Buffers)
- ä½¿ç”¨**æ•°æ®åº“è¿ç§»æœºåˆ¶** (å¦‚ `rusqlite` çš„ migration hooks)
- å°†å…±äº«çš„æ•°æ®ç»“æ„æå–åˆ°ç‹¬ç«‹çš„ `common` crate

---

## ğŸ“ˆ Churn Frequency Analysis

### **Top 10 Most Modified Files** (æŒ‰ä¿®æ”¹æ¬¡æ•°æ’åº)

| Rank | File | Churn | Type | Risk |
|------|------|-------|------|------|
| 1 | `src/main.rs` | 13 | GUIä¸»ç¨‹åº | âš ï¸ Medium |
| 2 | `service/src/injector/mod.rs` | 9 | Serviceæ ¸å¿ƒ | ğŸ”´ **HIGH** |
| 2 | `src/index.html` | 9 | UIæ¨¡æ¿ | âœ… Low |
| 2 | `src/styles.css` | 9 | æ ·å¼ | âœ… Low |
| 5 | `src/main_simple.js` | 8 | å‰ç«¯é€»è¾‘ | âš ï¸ Medium |
| 6 | `service/src/main.rs` | 7 | Serviceå…¥å£ | âœ… Low |
| 7 | `service/src/config/mod.rs` | 6 | é…ç½®ç®¡ç† | âœ… Low |
| 7 | `README.md` | 6 | æ–‡æ¡£ | âœ… Low |
| 9 | `Cargo.toml` | 5 | ä¾èµ–é…ç½® | âœ… Low |
| 9 | `service/src/db.rs` | 5 | æ•°æ®åº“ | âœ… Low |

**Insights**:
- `src/main.rs` ä¿®æ”¹æœ€é¢‘ç¹ (13æ¬¡)ï¼Œè¯´æ˜ GUI åŠŸèƒ½è¿­ä»£å¿«
- `injector/mod.rs` ä¿®æ”¹ 9 æ¬¡ + æé«˜å¤æ‚åº¦ = ğŸ”´ æœ€é«˜é£é™©æ–‡ä»¶

---

## ğŸ¯ Technical Debt Matrix

### **Debt Score Distribution**

```
 648 |  ğŸ”´ injector/mod.rs  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 312 |  âš ï¸  main.rs (GUI)   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 168 |  âš ï¸  main_simple.js  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  85 |  âœ… db.rs            â–ˆâ–ˆâ–ˆ
  84 |  âœ… service/main.rs  â–ˆâ–ˆâ–ˆ
  60 |  âœ… config/mod.rs    â–ˆâ–ˆ
  57 |  âœ… hotkey/mod.rs    â–ˆâ–ˆ
   5 |  âœ… context/mod.rs   |
```

**Interpretation**:
- **Debt Score = Churn Ã— Max CCN**
- `injector/mod.rs` çš„æŠ€æœ¯å€ºæ˜¯å…¶ä»–æ¨¡å—çš„ **5-10 å€**
- åˆ é™¤ UIA ç­–ç•¥åï¼Œé¢„è®¡å¯å‡å°‘ 400+ debt score

---

## ğŸ” Deep Dive: `injector/mod.rs`

### **Complexity Breakdown**

*Based on manual code review + automated metrics:*

| Component | LOC | CCN Est. | Responsibility |
|-----------|-----|----------|----------------|
| `inject_via_uia()` | ~400 | ~50 | UIA ç­–ç•¥ä¸»é€»è¾‘ |
| UIA è¾…åŠ©å‡½æ•° | ~100 | ~15 | ç„¦ç‚¹ç®¡ç†ã€é€‰åŒºæŠ˜å ã€TP2 å¤„ç† |
| `inject_via_clipboard()` | ~100 | ~5 | å‰ªè´´æ¿æ³¨å…¥ (ç®€å•) |
| `inject_via_sendinput()` | ~80 | ~3 | SendInput æ³¨å…¥ (ç®€å•) |
| ç¼–è¾‘å™¨æ£€æµ‹ | ~80 | ~8 | Electron/WPF/Swing/Scintilla |
| Selection Probing | ~80 | ~5 | å‰ªè´´æ¿æ¢é’ˆæ£€æµ‹é€‰åŒº |

**Total CCN**: ~72 (ç¬¦åˆå·¥å…·æ£€æµ‹çš„ max_ccn)

---

## ğŸš¨ Risk Assessment

### **Critical Risks** ğŸ”´

1. **`injector/mod.rs` Maintenance Hell**
   - **Impact**: æé«˜ - ä»»ä½•ä¿®æ”¹éƒ½å¯èƒ½ç ´åç°æœ‰åŠŸèƒ½
   - **Probability**: é«˜ - å·²ç»ä¿®æ”¹äº† 9 æ¬¡ï¼Œè¯´æ˜éœ€æ±‚ä»åœ¨å˜åŒ–
   - **Mitigation**: âœ… **åˆ é™¤ UIA ç­–ç•¥** (ç”¨æˆ·å·²ç¡®è®¤)

---

### **Medium Risks** âš ï¸

2. **Service â†” GUI è€¦åˆ**
   - **Impact**: ä¸­ç­‰ - å½±å“å¼€å‘æ•ˆç‡å’Œç¨³å®šæ€§
   - **Probability**: ä¸­ç­‰ - 0.54 è€¦åˆé¢‘ç‡
   - **Mitigation**: 
     - å®šä¹‰ç¨³å®šçš„ IPC Contract
     - å¼•å…¥ Schema Versioning
     - å°†å…±äº«ç±»å‹æå–åˆ° `common` crate

3. **GUI ä¸»ç¨‹åºå¿«é€Ÿè¿­ä»£**
   - **Impact**: ä¸­ç­‰ - 13 æ¬¡ä¿®æ”¹è¯´æ˜ä¸ç¨³å®š
   - **Probability**: ä¸­ç­‰
   - **Mitigation**: 
     - æ¨¡å—åŒ– JavaScript (æ‹†åˆ† `main_simple.js`)
     - å»ºç«‹ç»„ä»¶åº“

---

## ğŸ“¦ Coupling Recommendations

### **åº”è¯¥è€¦åˆçš„** (åˆç†ä¾èµ–)
- âœ… `service/src/main.rs` â†’ `config/mod.rs`
- âœ… `service/src/main.rs` â†’ `db.rs`
- âœ… `service/src/main.rs` â†’ `injector/mod.rs`
- âœ… `src/index.html` â†” `src/styles.css`

### **åº”è¯¥è§£è€¦çš„** (éšæ€§è€¦åˆ)
- âš ï¸ `service/src/main.rs` â†” `src/main.rs` (è·¨è¿›ç¨‹è€¦åˆ)
  - **è§£å†³æ–¹æ¡ˆ**: å®šä¹‰ç¨³å®šçš„ JSON-based IPC Protocol
  - **å…±äº«æ•°æ®ç»“æ„**: æå–åˆ° `promptkey-common` crate

### **å¯ä»¥ä¿æŒçš„** (ä½é¢‘è€¦åˆ)
- `Cargo.toml` â†” `src/main.rs` (åˆç†ï¼Œæ·»åŠ ä¾èµ–æ—¶ä¿®æ”¹)

---

## ğŸ¯ Refactoring Priorities (Based on Data)

### **ä¼˜å…ˆçº§ 1: åˆ é™¤ UIA ç­–ç•¥** ğŸ”¥
- **Target**: `service/src/injector/mod.rs`
- **Expected Impact**:
  - ğŸ—‘ï¸ å‡å°‘ ~500 LOC
  - ğŸ“‰ é™ä½ CCN ä» 72 â†’ ~10
  - ğŸ“‰ å‡å°‘ debt score ä» 648 â†’ ~100
  - âš¡ æå‡å¯ç»´æŠ¤æ€§ 10x

**User Confirmation**: âœ… å·²ç¡®è®¤

---

### **ä¼˜å…ˆçº§ 2: å®ç°å¿«é€Ÿé€‰æ‹©é¢æ¿** ğŸ¯
- **Architecture**: ç‹¬ç«‹çª—å£ (ç”¨æˆ·å·²ç¡®è®¤)
- **Dependencies**: 
  - `service/src/db.rs` (æŸ¥è¯¢ prompts)
  - æ–°å¢çƒ­é”®æ³¨å†Œ
  - æ–°å¢è½»é‡ UI çª—å£ (å¯èƒ½æ˜¯ Tauri webview æˆ– native Win32)

**Integration Points**:
- Option A: æ–°å¢ Tauri çª—å£ (å¤ç”¨ç°æœ‰æ¡†æ¶)
- Option B: Native Win32 + Webview2 (æ›´è½»é‡)

---

### **ä¼˜å…ˆçº§ 3: è§£è€¦ Service â†” GUI** âš ï¸
- **Target**: å‡å°‘è·¨è¿›ç¨‹è€¦åˆ (0.54 â†’ < 0.3)
- **Actions**:
  1. å®šä¹‰ JSON Schema for IPC
  2. å°†å…±äº«çš„ `Prompt` struct æå–åˆ° `common` crate
  3. æ•°æ®åº“ schema è¿ç§»æœºåˆ¶

---

### **ä¼˜å…ˆçº§ 4: æ¨¡å—åŒ–å‰ç«¯** (Optional)
- **Target**: `src/main_simple.js` (936 LOC)
- **Actions**: æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å— (Prompts, Settings, Logs, UI Utils)

---

## ğŸ”„ No Circular Coupling Detected âœ…

æ‰€æœ‰è€¦åˆéƒ½æ˜¯å•å‘æˆ–åˆç†çš„åŒå‘ä¾èµ–ï¼Œæ²¡æœ‰å‘ç°ç¯å½¢è€¦åˆã€‚

---

## ğŸ“ Comparison: Physical vs Logical Coupling

| Pair | Physical Dep | Logical Coupling | Verdict |
|------|--------------|------------------|---------|
| `service/main.rs` â†’ `config` | âœ… Yes (mod import) | âœ… 0.57 | åˆç† |
| `service/main.rs` â†’ `db` | âœ… Yes (mod import) | âœ… 0.57 | åˆç† |
| `service/main.rs` â†” `src/main.rs` | âŒ **No** | âš ï¸ **0.54** | **éšæ€§è€¦åˆ!** |

**Key Finding**: Service å’Œ GUI è¿›ç¨‹ä¹‹é—´**ä¸åº”è¯¥æœ‰ç›´æ¥çš„ä»£ç ä¾èµ–**ï¼Œä½†å´å­˜åœ¨ 0.54 çš„é€»è¾‘è€¦åˆï¼Œè¯´æ˜ä¸¤è€…çš„æ¥å£åè®®ä¸ç¨³å®šã€‚

---

## ğŸ› ï¸ Next Steps (Scout Workflow)

- âœ… **Step 3 Complete**: Git Forensics Analyzed
- ğŸ”œ **Step 4**: Invariant Hunting (æ·±å…¥ `injector/mod.rs` å¯»æ‰¾éšæ€§çº¦æŸ)
- ğŸ”œ **Step 5**: Concept Modeling (ä¸ºå¿«é€Ÿé€‰æ‹©é¢æ¿å»ºæ¨¡)
- ğŸ”œ **Step 6**: Interactive Q&A with User
- ğŸ”œ **Step 7**: Generate System Context Report

---

*End of Git Forensics Report*

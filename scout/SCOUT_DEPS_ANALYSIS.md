# Dependency Analysis Report - PromptKey

*Generated by: SCOUT (Phase: Step 2 - Dependency Topology Analysis)*  
*Date: 2025-12-26*  
*Analysis Scope: Entire PromptKey System (GUI + Service)*

---

## ğŸ“Š Executive Summary

**Project Type**: Rust-based Desktop Application (Tauri v2 + Windows API)  
**Architecture**: Dual-process (GUI + Background Service)  
**Language**: Rust 2021 Edition  
**Total Modules Analyzed**: 9 core modules (GUI: 1, Service: 8)  
**Cyclic Dependencies**: âŒ None detected  
**God Modules**: âš ï¸ 1 identified (`injector/mod.rs` - 839 LOC)

---

## ğŸ—ï¸ Architecture Overview

```
PromptKey/
â”œâ”€â”€ src/main.rs                  # GUIåº”ç”¨ (Tauri, 858 LOC)
â”‚   â””â”€â†’ Tauri Runtime
â”‚   â””â”€â†’ SQLite Database (direct access)
â”‚   â””â”€â†’ Service Process (spawn/manage)
â”‚
â””â”€â”€ service/src/                 # åå°æœåŠ¡ (Native Rust)
    â”œâ”€â”€ main.rs                  # Service Entry (323 LOC)
    â”‚   â””â”€â†’ config
    â”‚   â””â”€â†’ db
    â”‚   â””â”€â†’ hotkey
    â”‚   â””â”€â†’ injector
    â”‚   â””â”€â†’ context
    â”‚
    â”œâ”€â”€ config/mod.rs            # é…ç½®ç®¡ç† (290 LOC)
    â”‚   â””â”€â†’ YAML Parser (serde_yaml)
    â”‚
    â”œâ”€â”€ db.rs                    # æ•°æ®åº“å±‚ (330 LOC)
    â”‚   â””â”€â†’ rusqlite
    â”‚
    â”œâ”€â”€ hotkey/mod.rs            # çƒ­é”®ç›‘å¬ (395 LOC)
    â”‚   â””â”€â†’ Windows API (RegisterHotKey, MSG Loop)
    â”‚   â””â”€â†’ config
    â”‚
    â”œâ”€â”€ injector/mod.rs          # âš ï¸ æ–‡æœ¬æ³¨å…¥æ ¸å¿ƒ (839 LOC) [GOD MODULE]
    â”‚   â””â”€â†’ config
    â”‚   â””â”€â†’ Windows UI Automation (UIA)
    â”‚   â””â”€â†’ Clipboard API
    â”‚   â””â”€â†’ SendInput API
    â”‚
    â”œâ”€â”€ context/mod.rs           # åº”ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥
    â”‚   â””â”€â†’ Windows API (GetForegroundWindow)
    â”‚
    â””â”€â”€ (no circular deps detected)
```

---

## ğŸ” Physical Dependency Graph

### **Service Module Dependencies**

```mermaid
graph TD
    Main[service/main.rs] -->|uses| Config[config/mod.rs]
    Main -->|uses| DB[db.rs]
    Main -->|uses| Hotkey[hotkey/mod.rs]
    Main -->|uses| Injector[injector/mod.rs]
    Main -->|uses| Context[context/mod.rs]
    
    Hotkey -->|reads| Config
    Injector -->|reads| Config
    Injector -.->|optionally calls| Clipboard[Clipboard API]
    Injector -.->|optionally calls| UIA[UI Automation]
    Injector -.->|optionally calls| SendInput[SendInput API]
    
    DB -->|writes| SQLite[(SQLite DB)]
    
    style Main fill:#ff6b6b
    style Injector fill:#ffd93d,stroke:#333,stroke-width:3px
    style Config fill:#6bcf7f
    style DB fill:#4ecdc4
```

### **GUI Dependencies**

```mermaid
graph TD
    GUI[src/main.rs] -->|embeds| Tauri[Tauri Runtime]
    GUI -->|spawns| ServiceExe[service.exe]
    GUI -->|direct SQL| SQLite[(SQLite DB)]
    ServiceExe -->|writes| SQLite
    
    style GUI fill:#a8e6cf
    style ServiceExe fill:#ff6b6b
```

---

## âš ï¸ God Module Analysis

### **`service/src/injector/mod.rs` (839 LOC)**

**Risk Level**: ğŸ”´ **HIGH**

**Reasons**:
1. **Complexity**: 839 lines of procedural logic with heavy conditional branching
2. **Multiple Responsibilities**:
   - UIA (UI Automation) strategy implementation (~500 LOC)
   - Clipboard manipulation (~100 LOC)
   - SendInput simulation (~80 LOC)
   - Editor-specific focus handling (Electron/WPF/Swing/Scintilla)
   - Selection collapse detection via TextPattern/TextPattern2
   - Clipboard probing for selection detection
3. **Tight Coupling**: Directly depends on Windows API (12+ APIs)
4. **Fragility**: Containså¤šä¸ª `unsafe` blocks and edge-case handling

**Recommended Action**: ğŸ¯ **[USER REQUEST CONFIRMED]** - Delete UIA strategy, simplify to Clipboard + optional SendInput

---

## ğŸ“¦ Module Inventory

| Module | LOC | Responsibility | External Dependencies | å¤æ‚åº¦ |
|--------|-----|----------------|----------------------|--------|
| `src/main.rs` | 858 | GUIä¸»è¿›ç¨‹ã€Tauriå°è£…ã€Serviceç®¡ç† | Tauri, rusqlite, serde | Medium |
| `service/main.rs` | 323 | Serviceå…¥å£ã€æ³¨å…¥è¯·æ±‚å¤„ç†å¾ªç¯ | - | Medium |
| `service/config/mod.rs` | 290 | YAMLé…ç½®åŠ è½½ã€é¢„å®šä¹‰åº”ç”¨é…ç½® | serde_yaml | Low |
| `service/db.rs` | 330 | SQLiteæ“ä½œã€Prompt CRUD | rusqlite | Low |
| `service/hotkey/mod.rs` | 395 | å…¨å±€çƒ­é”®æ³¨å†Œã€MSGå¾ªç¯ | Windows API | Medium |
| **`service/injector/mod.rs`** | **839** | **å¤šç­–ç•¥æ–‡æœ¬æ³¨å…¥** | **Windows API (UIA/Clipboard/SendInput)** | **ğŸ”´ Very High** |
| `service/context/mod.rs` | ~100 | è·å–å‰å°çª—å£ä¿¡æ¯ | Windows API | Low |

---

## ğŸš¨ Architecture Risks

### **1. UIA Complexity Explosion** ğŸ”´

**Problem**:
- UIA implementation is overly complex (500+ LOC)
- Handles edge cases for: Chrome/Electron, WPF, Swing, Scintilla
- Uses TextPattern, TextPattern2, ValuePattern with fallback logic
- Probes selection via clipboard (destructive read)

**Impact**:
- Hard to maintain
- Prone to regression when Windows updates UIA API
- Poor performance (multiple retries, delays, clipboard operations)

**User's Refactoring Request**: âœ… **DELETE UIA, use Clipboard as primary**

---

### **2. Dual Database Access** âš ï¸

**Problem**:
- GUI (`src/main.rs`) and Service (`service/db.rs`) both access the same SQLite database
- Potential for race conditions (though WAL mode is enabled)

**Evidence**:
- GUI: `open_db()` in `src/main.rs:430-503`
- Service: `Database::new()` in `service/src/db.rs`

**Mitigation**: Using SQLite WAL mode + `busy_timeout`

---

### **3. Service Lifecycle Management** âš ï¸

**Problem**:
- GUI spawns `service.exe` as child process
- No proper health check or auto-restart mechanism

**Evidence**:
```rust
// src/main.rs:64-96
fn start_service() {
    Command::new(service_path)
        .spawn()?;
}
```

---

## ğŸ¯ Refactoring Targets (Based on User Request)

### **Priority 1: Simplify Injection Strategy** ğŸ”¥

**Current State**:
```rust
enum InjectionStrategy {
    UIA,           // 500+ LOC, å¤æ‚åº¦æé«˜
    Clipboard,     // 100 LOC, ç®€å•å®ç”¨
    SendInput,     // 80 LOC, å…œåº•æ–¹æ¡ˆ
}
```

**Target State** (User Request):
```rust
enum InjectionStrategy {
    Clipboard,     # Primary (ç®€å•ã€å¯é ã€è·¨åº”ç”¨å…¼å®¹)
    SendInput,     # Fallback (é’ˆå¯¹ç¦ç”¨ç²˜è´´çš„åœºæ™¯)
}
```

**Benefits**:
- âœ… Remove 500+ LOC of complex UIA code
- âœ… Eliminate editor-specific focus handling
- âœ… Reduce unsafe blocks by ~60%
- âœ… Improve injection success rate (clipboard works in more scenarios than UIA)

---

### **Priority 2: Add Quick Selection Panel UI** ğŸ¯

**User Requirements**:
1. çƒ­é”®å”¤èµ·è½»é‡æµ®åŠ¨çª—å£
2. æ¨¡ç³Šæœç´¢ Prompts
3. é”®ç›˜å¯¼èˆª (â†‘â†“é€‰æ‹©)
4. å›è½¦å¤åˆ¶åˆ°å‰ªè´´æ¿

**Integration Points**:
- **New Module**: `service/src/selector/mod.rs` (or integrate into GUI)
- **Dependencies**: 
  - `db.rs` (query prompts)
  - `hotkey/mod.rs` (register new hotkey for selector)
  - GUI (if using Tauri window for selector UI)

**Architecture Decision Required**:
- Option A: Selector as **standalone lightweight window** (native Win32 + Webview)
- Option B: Selector integrated into **main Tauri window** (reuse existing GUI)

---

## ğŸ“ Dependency Metrics

| Metric | Value | Notes |
|--------|-------|-------|
| **Coupling Index** | Medium | Most modules depend on `config`, but no cyclic deps |
| **Cohesion** | Good | Each module has clear responsibility except `injector` |
| **Stability** | Medium | Heavy reliance on Windows API (OS version dependency) |
| **Testability** | Low | Extensive use of `unsafe` and external Windows API |

---

## ğŸ”„ No Circular Dependencies Detected âœ…

All dependencies flow in a **DAG (Directed Acyclic Graph)**:
```
main.rs 
  â†“
[config, db, hotkey, injector, context]
  â†“
Windows API / External Libraries
```

---

## ğŸ› ï¸ Tool Limitations

**Note**: Automated dependency analysis (`dep_map_rs.py`) only captured top-level module dependencies.  
**Reason**: Rust's module system with `mod.rs` makes fine-grained analysis challenging.  
**Approach**: Manual code review was performed to supplement automated analysis.

---

## Next Steps (Scout Workflow)

- âœ… **Step 2 Complete**: Dependency Topology Analyzed
- ğŸ”œ **Step 3**: Git Forensics (Identify high-churn files and logical coupling)
- ğŸ”œ **Step 4**: Invariant Hunting (Find implicit constraints and hidden assumptions)
- ğŸ”œ **Step 5**: Concept Modeling (Model the "Quick Selection Panel" feature)

---

*End of Dependency Analysis Report*

# TODO — Prompt Manager（Windows MVP，聚焦 UIA 注入与控制面板）

更新时间：2025-08-24

## 当前状态

- 构建：PASS（无阻塞错误）。
- 运行：PASS。热键消息循环稳定，WM_HOTKEY 投递可靠。
- 注入：
	- UIA 主路径：ValuePattern.SetValue（支持 append/overwrite），带读回验证；密码字段自动拒绝。
	- 无 ValuePattern 时：TextPattern 放置光标（末尾/当前位置），优先剪贴板粘贴，失败回退 SendInput。
	- 前置目标窗口、防抖与小延迟已加，稳定性良好。
- 配置：YAML 生效，热键/注入参数可改，变更后可平滑生效。
- 数据：SQLite（WAL）OK，usage_logs 记录注入行为，prompts CRUD 可用。

## 交付目标（重心）

P0 — UIA 注入稳定性（能力驱动优先）
- [ ] ValuePattern 路径完善：
	- [ ] 失败/不变场景再验证（VS Code/Chromium 文本框等），确保按配置 append/overwrite 行为一致。
	- [ ] 读回验证策略可配置（次数/间隔/终止条件）。
- [ ] TextPattern 路径完善：
	- [ ] 选区存在时执行替换；无选区时按配置决定“末尾”或“当前位置”。
	- [ ] 末尾移动逻辑在大型文档/虚拟化编辑器上增加重试与上限保护。
- [ ] 剪贴板回退（安全模式）：
	- [ ] 快照→注入→恢复（互斥/超时/失败降级）。
	- [ ] 与系统/第三方剪贴板管理器兼容性检查。
- [ ] SendInput 回退：
	- [ ] 长文本分批、节流与 IME/组合键干扰规避。
- [ ] 能力驱动策略（不做应用名特例，或通过配置开关控制特例）。

P0 — 控制面板（GUI/Tauri）完工
- [ ] 设置页：
	- [ ] 热键录制（冲突检测、应用后热更新）。
	- [ ] 注入策略顺序与参数：allow_clipboard、uia_value_pattern_mode（append/overwrite）、验证次数与延时。
	- [ ] 数据库路径、日志级别、开机自启。
- [ ] 提示词面板：
	- [ ] 列表/搜索/增删改查，与 SQLite 对接；导入导出（JSON/YAML）。
- [ ] 使用记录：
	- [ ] 查看 usage_logs（过滤/导出 CSV），一键复制错误详情。
- [ ] 服务控制：
	- [ ] 启动/停止/重载配置；托盘菜单与状态指示。
- [ ] 主题与无障碍：浅/深色、字号、快捷键可达性。

P1 — 兼容性与测试
- [ ] 兼容性清单与冒烟脚本：Notepad、WordPad、VS Code、Edge/Chrome 文本框、IntelliJ、Visual Studio。
- [ ] 端到端烟雾测试（本地脚本 + 手动指引），记录成功率与耗时。
- [ ] 单元测试：热键解析、配置加载、策略选择、数据库 CRUD。

P1 — 可观测性与文档
- [ ] 运行日志与故障排查手册（常见注入失败原因与自检步骤）。
- [ ] 使用统计（本地）：近 N 次注入成功率、回退频率、均耗时。

P2 — 体验与发布
- [ ] SendInput 高级优化（粘连键/重复键防护、退格/换行语义）。
- [ ] 安装与签名（MSI/EXE，自动更新预研）。
- [ ] 云同步占位（延后实现）。

## 已完成（摘要）
- [x] 热键服务与消息循环；失败回退热键组合；优雅退出。
- [x] UIA 主路径与 TextPattern/剪贴板/SendInput 回退链路。
- [x] 配置读写（%APPDATA%）；WAL 数据库初始化与 prompts/usage_logs。
- [x] 目标窗口前置；密码字段保护；日志增强与错误透传。

## 里程碑
- M1（P0 完成）：UIA 注入在清单应用中≥95% 成功率；控制面板可调参并热更新；剪贴板回退具备快照恢复。
- M2（P1 完成）：兼容性脚本齐备；端到端稳定；文档完善。
- M3（P2 完成）：体验优化与安装签名准备。

备注
- 若需彻底移除“应用特例”，可将编辑器特化分支置于配置开关（默认关闭），以保持能力驱动一致性。
# TODO — Prompt Manager (Windows MVP)

## 状态快照（2025-08-17）

- 构建：PASS（少量 warnings 待清理）。
- 运行：PASS。热键线程内注册 + 消息循环，WM_HOTKEY 可靠投递。
- 注入：UIA 主路径（ValuePattern.SetValue）OK；当无 ValuePattern 时，TextPattern+SendInput 末尾插入回退 OK。
- 配置：默认仅启用 UIA；即使旧配置包含其它策略也会忽略（记录 Info 日志）。
- 数据：SQLite（WAL）初始化 OK；prompts 默认示例存在；usage_logs 已写入注入记录（app/window/strategy/success/error/result）。
- 工具：scripts/smoke.ps1 可在记事本中端到端验证。

已知问题/待改进
- 终端/文件查看器编码差异可能导致中文标题显示为"乱码"（实为查看器编码问题；我们已增大缓冲区降低截断风险，但仍建议输出到 UTF-8 文件）。
- 一些 warnings（未用 import/字段/枚举分支等）。
- 仅在 Notepad 做了冒烟验证，缺少其它常见编辑控件的兼容性清单。

## 当前重点任务（按优先级排序）

### 1. 改进热键注册错误处理（P0）
- [x] 热键失败时打印 GetLastError/HRESULT
- [x] 准备备用热键组合做降级尝试

### 2. 实现最小可用注入器（P0）
- [x] UIA ValuePattern 注入
- [x] TextPattern + SendInput 末尾插入回退
- [ ] （可选）安全剪贴板注入（快照→注入→恢复）

### 3. 接入上下文信息（P1）
- [x] 从 context 获取前景窗口信息
- [x] 将上下文信息带入日志与使用记录

### 4. 优化消息循环（P1）
- [x] 热键注册与消息循环在同一线程
- [x] 将消息循环线程封装为专用类型

### 5. 清理与测试（P2）
- [x] 清理未用代码/导入，或加 allow 说明
- [ ] 补一个极简的集成冒烟用例

## 建议的下一步路线图（可作为接下来 1-2 个小迭代）

P0 — 稳定性与可观测性（优先）
- [x] 日志输出到 UTF-8 文件（带滚动/按大小切割），保留控制台日志；统一编码，避免中文显示问题。
- [x] usage_logs 导出小脚本（CSV）：最近 N 条、时间范围过滤、成功/失败过滤。
- [x] HotkeyService 同线程与优雅退出：
	- [x] 将 RegisterHotKey 移入消息循环线程（保证 WM_HOTKEY 投递到同线程队列）。
	- [x] 启动时保存循环线程的线程 ID 与 JoinHandle。
	- [x] stop(): 先 PostThreadMessageW(WM_QUIT) → 再 UnregisterHotKey → 最后 join() 等待线程退出。
	- [x] 完善注册/注销/退出路径的错误处理与详细日志（含 GetLastError）。
- [x] 解决现有 warnings：
	- [x] 移除未用导入（例如 injector 中未用的 Foundation）。
	- [x] 对暂未使用的字段/分支加 #[allow(dead_code)] 或开始实用化（如 window_handle、Clipboard/SendInput）。

P1 — 兼容性与注入语义
- [x] 注入前确保目标窗口前置（基于 window_handle 使用 SetForegroundWindow），提升跨应用稳定性。
- [x] 增加配置项：ValuePattern 路径支持"覆盖"或"末尾追加"两种模式（默认仍为覆盖）。
- [x] TextPattern 路径研究与增强：在存在选区时优先"替换选区"，否则"末尾追加"（需验证目标应用行为；可能仍以 SendInput 实现）。
- [x] 兼容性清单：在常见应用中做冒烟（Notepad、WordPad、VS Code、Chrome/Edge 文本框等），记录每个的可用策略与注意事项。

P1 — GUI 外壳（页面脚手架）
- [x] 技术选型与脚手架（待定：Tauri + 前端/Slint/egui+winit；Windows 优先，先以最小外壳为目标）。
- [x] 路由与页面框架（导航/标签/页内状态）。
- [x] 提示词管理面板（列表、搜索、增删改查 UI；与本地 SQLite CRUD 打通）。
- [x] 市场页面（先搭空页面与基本布局，功能占位，后续再接入数据）。
- [x] 设置页面：
	- [x] 快捷键设置（读写 config.yaml；应用后热键服务平滑重启）。
	- [x] 云同步（页面占位，功能暂缓）。
	- [x] 主题与外观（浅色/深色、字体与字号选项；保存到配置）。
- [x] 托盘与入口（系统托盘菜单、启动/退出、开机自启）。

P2 — 回退与测试
- [ ] （可选）剪贴板回退（快照→注入→恢复，带超时与互斥保护）。
- [ ] 单元测试：热键解析、配置加载、数据库操作、策略选择。
- [ ] 集成测试脚本：失败回退路径、不同应用上下文、长文本/大负载节流策略（为后续 SendInput 优化预留）。

## 原始功能开发计划（暂不处理，待重构完成后再继续）

<details>
<summary>点击查看原始功能开发计划</summary>

## 0. 项目初始化（已完成）
- [x] 建立 Rust 工作区与 `service` crate（后台服务）
- [x] 加入依赖：windows、tokio、rusqlite、serde、env_logger
- [x] 实现配置加载 `%APPDATA%/PromptManager/config.yaml`
- [x] SQLite 初始化与迁移（WAL + 两张表）
- [x] 全局热键注册与消息循环（默认 `Ctrl+Alt+Space`）
- [x] 注入流水线骨架：UIA→剪贴板→SendInput（可运行占位）
- [x] README 写明运行方法

## 1. 注入实现
### 1.1 UIA注入策略
- [x] 实现UIA基本框架（COM初始化、获取焦点元素）
- [x] 实现ValuePattern.SetValue方法注入文本
- [x] 实现TextPattern末尾插入（通过 SendInput 回退）
- [x] 实现密码框识别与拒绝注入
- [x] 测试：在记事本等支持UIA的应用中验证注入功能

### 1.2 剪贴板注入策略
- [ ] 实现剪贴板内容快照功能
- [ ] 实现剪贴板内容恢复功能
- [ ] 实现Ctrl+V按键发送功能
- [ ] 实现并发保护（互斥）机制
- [ ] 实现超时回滚机制
- [ ] 测试：在不支持UIA的应用中验证剪贴板注入功能

### 1.3 SendInput注入策略
- [ ] 实现UTF-16批量键入功能
- [ ] 实现适当的sleep/分批机制避免丢键
- [ ] 实现节流控制功能
- [ ] 测试：在剪贴板不可用时验证SendInput注入功能

## 2. 上下文与规则
### 2.1 前台窗口信息获取
- [x] 实现获取前台窗口句柄功能
- [x] 实现获取窗口进程名功能
- [x] 实现获取窗口标题功能
- [ ] 测试：验证不同应用的上下文信息获取准确性

### 2.2 应用规则匹配
- [ ] 实现按应用规则匹配默认模板功能
- [ ] 实现按应用规则匹配注入策略优先级功能
- [ ] 测试：验证不同应用的模板和策略匹配准确性

## 3. 模板与变量（MVP）
### 3.1 模板管理
- [x] 实现prompts表CRUD操作功能
- [ ] 实现模板标签和版本管理功能
- [ ] 测试：验证模板的增删改查功能

### 3.2 变量替换
- [ ] 实现简单字符串变量替换功能
- [ ] 实现变量默认值处理功能
- [ ] 测试：验证模板中变量的正确替换

## 4. 交互入口（过渡版）
### 4.1 热键触发注入
- [x] 实现热键触发固定模板注入功能
- [ ] 实现注入结果反馈机制
- [ ] 测试：验证端到端的热键触发注入流程

### 4.2 使用日志记录
- [x] 实现 usage_logs 表记录（app/window/策略/成功标记/错误/耗时）
- [ ] 测试：验证使用日志的正确记录

## 5. 稳定性与测试
### 5.1 单元测试
- [ ] 实现热键解析单元测试
- [ ] 实现配置加载单元测试
- [ ] 实现数据库操作单元测试
- [ ] 实现注入策略选择单元测试

### 5.2 集成测试
- [ ] 实现记事本注入验证脚本
- [ ] 实现不同应用上下文测试脚本
- [ ] 实现失败回退机制测试脚本

## 6. 文档与打包
### 6.1 文档完善
- [ ] 完善README运行与故障排查说明
- [ ] 添加配置文件详细说明
- [ ] 添加常见问题解答

### 6.2 打包与签名
- [ ] 实现Cargo发布profile优化
- [ ] 实现Windows签名方案
- [ ] 实现安装器打包功能